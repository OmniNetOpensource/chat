<!-- c5c92f19-f56a-4743-8502-96ef87b30ab6 c9632e02-545b-438a-afc6-017bccd470ea -->

# 增强 useChatStore 错误处理和恢复能力

## 当前问题分析

`useChatStore.ts` 存在以下错误处理缺陷：

1. **网络错误处理不足**（第 90-221 行）：

- 仅有基础的 try-catch，错误只打印到控制台
- 没有自动重试机制
- 缺少超时控制
- AbortError 被静默忽略但没有清理错误状态

2. **IndexedDB 操作无保护**（第 81-88, 211-220 行）：

- `saveConversation` 调用没有错误处理
- 失败时会导致用户数据丢失
- 没有降级方案

3. **流式响应解析脆弱**（第 142-201 行）：

- JSON 解析失败只打印错误
- 没有部分成功的处理
- 解析错误会导致静默失败

4. **状态管理问题**：

- `error` 状态设置后从不清除（第 111 行）
- 发送失败时消息已经添加到 messages 数组
- 没有状态回滚机制

5. **错误信息不友好**（第 111 行）：

- 技术性错误直接暴露给用户
- 没有操作建议

## 改进方案

### 1. 添加错误类型定义和工具函数

在 `useChatStore.ts` 顶部添加：

- 自定义错误类型（网络错误、数据库错误、解析错误）
- 错误分类函数（判断是否可重试）
- 指数退避重试工具函数
- 用户友好的错误消息转换函数

### 2. 增强网络请求错误处理

改进 `sendMessage` 方法（第 58-221 行）：

- **添加超时控制**：使用 `Promise.race` 实现 60 秒超时
- **实现自动重试**：可重试错误（网络、超时、5xx）自动重试最多 3 次
- **指数退避**：重试间隔为 1s、2s、4s
- **错误状态管理**：设置清晰的错误信息，发送前清除旧错误
- **状态回滚**：失败后恢复到发送前的消息状态

### 3. 保护 IndexedDB 操作

为所有 IndexedDB 调用添加错误处理：

- 第 81-88 行：用户消息保存失败时警告但不阻塞
- 第 211-220 行：AI 响应保存失败时记录错误
- 实现简单的内存降级（可选）

### 4. 改进流式响应处理

增强第 116-204 行的流处理逻辑：

- 捕获并记录解析错误
- 格式错误不中断整个流
- 记录成功解析的消息数量

### 5. 错误状态管理

改进错误状态使用：

- 在 `sendMessage` 开始时清除旧错误
- 在 `clear` 方法中清除错误（第 236 行）
- 添加 `clearError` 方法供 UI 调用
- 在成功时自动清除错误

### 6. 添加手动重试方法

新增 `retryLastMessage` 方法：

- 重试最后一次失败的请求
- 复用现有的重试逻辑
- 供 UI 在自动重试失败后使用

## 关键代码位置

- **sendMessage 方法**：第 58-221 行（主要改进区域）
- **IndexedDB 调用**：第 81-88, 211-220 行
- **流处理循环**：第 125-204 行
- **错误状态**：第 44, 111, 277 行
- **clear 方法**：第 236-244 行

## 兼容性保证

- 保持所有现有 API 签名不变
- 组件无需修改即可受益
- 新增的方法为可选使用

### To-dos

- [ ] 添加错误类型定义、重试工具函数和错误消息转换函数
- [ ] 为 sendMessage 添加超时控制、自动重试和指数退避机制
- [ ] 为所有 IndexedDB 操作添加 try-catch 错误处理
- [ ] 增强流式响应的错误处理，避免单个解析错误中断整个流
- [ ] 实现消息状态回滚机制，失败时恢复到发送前状态
- [ ] 改进错误状态管理，添加 clearError 方法和自动清除逻辑
